function e(){return indexedDB.open("MeeExtensionDB",7)}function n(){return new Promise(((n,t)=>{const a=[],o=e();o.onerror=()=>{t()},o.onsuccess=function(e){const t=e.target.result;t.transaction(["domains"],"readwrite").objectStore("domains").openCursor().onsuccess=e=>{const t=e.target.result;t?(!1===t.value.enabled&&a.push(t.value.domain),t.continue()):n(a)},t.close()}}))}async function t(n){return new Promise(((t,a)=>{const o=e();o.onerror=()=>{a()},o.onsuccess=function(e){const o=e.target.result,s=o.transaction(["domains"],"readwrite").objectStore("domains").get(n);s.onerror=()=>{a()},s.onsuccess=e=>{t(e.target.result)},o.close()}}))}e().onupgradeneeded=function(e){const n=e.target.result,t=n.createObjectStore("domains",{keyPath:"domain"});t.createIndex("wellknown","wellknown",{unique:!1}),t.createIndex("enabled","enabled",{unique:!1}),t.createIndex("domain","enabled",{unique:!0}),n.close()};let a=!1;async function o(e,n,t="enable"){let a={addRules:[{id:e,priority:2,action:{type:"modifyHeaders",requestHeaders:"remove"===t?[{header:"Sec-GPC",operation:"remove"},{header:"DNT",operation:"remove"}]:[{header:"Sec-GPC",operation:"set",value:"enable"===t?"1":"0"},{header:"DNT",operation:"set",value:"enable"===t?"1":"0"}]},condition:{urlFilter:n,resourceTypes:["main_frame","sub_frame","stylesheet","script","image","font","object","xmlhttprequest","ping","csp_report","media","websocket","other"]}}],removeRuleIds:[e]};await chrome.declarativeNetRequest.updateDynamicRules(a)}async function s(){(await chrome.declarativeNetRequest.getDynamicRules()).map((e=>e.id)).map((async e=>{o(e,"*","remove")}))}async function r(){let e=1;const t=await n();if(console.log("disable_domains: ",t),t)for(let n of t){const t=`*://${n}/*`;await o(e++,t,"remove")}}function c(n,t){let a=t.tab.id,o=(s=t.url,new URL(s).hostname.replace("www.",""));var s;let r=[];r[a]=n.data;let c=n.data;const i=!(!r[a]||!0!==r[a].gpc);var d;!0===i&&chrome.action.setIcon({tabId:a,path:"images/icon-96.png"}),d={domain:o,wellknown:i,enabled:!0},e().onsuccess=function(e){const n=e.target.result.transaction(["domains"],"readwrite").objectStore("domains");n.get(d.domain).onsuccess=e=>{const t=e.target.result,a=t&&!t.enabled?{domain:d.domain,wellknown:d.gpc,enabled:!1}:d,o=n.put(a);o.onerror=e=>{console.warn("requestUpdate error",e)},o.onsuccess=e=>{console.log("requestUpdate onsuccess",e)}}},chrome.runtime.onMessage.addListener((function(e,n,t){"POPUP_LOADED"===e.msg&&chrome.runtime.sendMessage({msg:"SEND_WELLKNOWN_TO_POPUP",data:{domain:o,wellknownData:c}})}))}chrome.runtime.onInstalled.addListener((async function(){const e=await t("meeExtension"),n=!e||e.enabled;a=!n,n?(await o(1,"*"),await r()):await s()})),chrome.runtime.onMessage.addListener(((e,i,d)=>{switch(e.msg){case"DOWNLOAD_WELLKNOWN":return c(e,i),!0;case"UPDATE_SELECTOR":return o(1,e.domain,e.mode),!0;case"UPDATE_ENABLED":return async function(){await s();const e=await t("meeExtension"),n=!e||e.enabled;a=!n,n?(chrome.runtime.sendMessage({msg:"ENABLE_DOM"}),await o(1,"*"),await r()):await s()}(),!0;case"APP_COMMUNICATION":return function(e,n){new Promise((n=>{chrome.runtime.sendNativeMessage("Mee",{type:e.type,message:e.data},(e=>{n(e)}))})).then((e=>{n(e)})).catch((e=>{console.log("error: ",e),n(e)}))}(e,d),!0;case"CHECK_ENABLED":return async function(e,t){t({isEnabled:-1===(await n()).findIndex((n=>n===e.data))&&!a})}(e,d),!0;default:return!1}}));
