function e(){return indexedDB.open("MeeExtensionDB",7)}function n(){return new Promise(((n,t)=>{const a=[],o=e();o.onerror=e=>{t()},o.onsuccess=function(e){const t=e.target.result;t.transaction(["domains"],"readwrite").objectStore("domains").openCursor().onsuccess=e=>{const t=e.target.result;t?(!1===t.value.enabled&&a.push(t.value.domain),t.continue()):n(a)},t.close()}}))}async function t(n){return new Promise(((t,a)=>{const o=e();o.onerror=e=>{a()},o.onsuccess=function(e){const o=e.target.result,s=o.transaction(["domains"],"readwrite").objectStore("domains").get(n);s.onerror=e=>{a()},s.onsuccess=e=>{t(e.target.result)},o.close()}}))}e().onupgradeneeded=function(e){const n=e.target.result,t=n.createObjectStore("domains",{keyPath:"domain"});t.createIndex("wellknown","wellknown",{unique:!1}),t.createIndex("enabled","enabled",{unique:!1}),t.createIndex("domain","enabled",{unique:!0}),n.close()};let a=[],o=!1;async function s(e,n){let t={addRules:[{id:e,priority:2,action:{type:"modifyHeaders",requestHeaders:[{header:"Sec-GPC",operation:"remove"},{header:"DNT",operation:"remove"}]},condition:{urlFilter:n,resourceTypes:["main_frame","sub_frame","stylesheet","script","image","font","object","xmlhttprequest","ping","csp_report","media","websocket","webtransport","webbundle","other"]}}],removeRuleIds:[e]};await chrome.declarativeNetRequest.updateDynamicRules(t)}async function r(){let e=chrome.declarativeNetRequest.MAX_NUMBER_OF_DYNAMIC_AND_SESSION_RULES,n={removeRuleIds:[...Array(e).keys()]};await chrome.declarativeNetRequest.updateDynamicRules(n)}async function i(){let e=1;const t=await n();if(t){a=t;for(let n of t)await s(e++,n)}}function c(n,t){let a=t.tab.id,o=new URL(t.origin).hostname.replace("www.",""),s=[];s[a]=n.data;let r=n.data;const i=!(!s[a]||!0!==s[a].gpc);var c;!0===i&&chrome.action.setIcon({tabId:a,path:"images/icon-96.png"}),c={domain:o,wellknown:i,enabled:!0},e().onsuccess=function(e){const n=e.target.result.transaction(["domains"],"readwrite").objectStore("domains");n.get(c.domain).onsuccess=e=>{const t=e.target.result,a=t&&!t.enabled?{domain:c.domain,wellknown:c.gpc,enabled:!1}:c,o=n.put(a);o.onerror=e=>{console.warn("requestUpdate error",e)},o.onsuccess=e=>{console.log("requestUpdate onsuccess",e)}}},chrome.runtime.onMessage.addListener((function(e,n,t){"POPUP_LOADED"===e.msg&&chrome.runtime.sendMessage({msg:"SEND_WELLKNOWN_TO_POPUP",data:{domain:o,wellknownData:r}})}))}chrome.runtime.onMessage.addListener((function(e,n,t){if("CHECK_ENABLED"===e.msg){return t({isEnabled:-1===a.findIndex((n=>n===e.data))&&!o}),!0}})),chrome.runtime.onMessage.addListener((async function(e,n,a){switch(e.msg){case"DOWNLOAD_WELLKNOWN":c(e,n);break;case"UPDATE_SELECTOR":await r(),await i();break;case"UPDATE_ENABLED":await async function(){await r();const e=await t("meeExtension"),n=!e||e.enabled;o=!n,n?await i():await s(1,"*")}()}return!0})),chrome.runtime.onInstalled.addListener((async function(e){const r=await n();r&&(a=r);const c=await t("meeExtension"),d=!c||c.enabled;o=!d,d?await i():await s(1,"*")}));
